// src/db/index.ts
import { drizzle } from "drizzle-orm/node-postgres"
import { Pool } from "pg"
import * as schema from "./schema"

const globalForDb = globalThis as unknown as {
  pool: Pool | undefined
}

function createPool(): Pool {
  const unixSocket = process.env.INSTANCE_UNIX_SOCKET

  const poolConfig = {
    ...(unixSocket
      ? {
          user: process.env.DB_USER,
          password: process.env.DB_PASS,
          database: process.env.DB_NAME,
          host: unixSocket,
        }
      : {
          connectionString: process.env.DATABASE_URL,
        }),
    max: 5,
    min: 0,
    idleTimeoutMillis: 30000,
    connectionTimeoutMillis: 10000,
    // This is the important one â€” detect dead connections
    keepAlive: true,
    keepAliveInitialDelayMillis: 10000,
    allowExitOnIdle: true,
  }

  const newPool = new Pool(poolConfig)

  newPool.on("error", (err) => {
    console.error("[DB Pool] Unexpected error on idle client:", err.message)
  })

  return newPool
}

const pool = globalForDb.pool ?? createPool()
globalForDb.pool = pool

export const db = drizzle(pool, { schema })